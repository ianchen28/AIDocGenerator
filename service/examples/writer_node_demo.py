#!/usr/bin/env python3
"""
æ¼”ç¤ºwriter_nodeçš„æ–‡æ¡£ç”ŸæˆåŠŸèƒ½
"""

import sys
from pathlib import Path

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
current_file = Path(__file__)
service_dir = current_file.parent.parent  # service ç›®å½•
if str(service_dir) not in sys.path:
    sys.path.insert(0, str(service_dir))

from core.config import settings
from src.doc_agent.graph.nodes import writer_node
from src.doc_agent.graph.state import ResearchState
from src.doc_agent.llm_clients.providers import InternalLLMClient


def test_writer_node():
    """æµ‹è¯•writer_nodeçš„æ–‡æ¡£ç”ŸæˆåŠŸèƒ½"""

    print("ğŸš€ å¼€å§‹æµ‹è¯•writer_nodeæ–‡æ¡£ç”ŸæˆåŠŸèƒ½...")

    # åˆ›å»ºæµ‹è¯•çŠ¶æ€
    state = ResearchState()
    state["topic"] = "ç”µåŠ›ç³»ç»Ÿè¿è¡Œä¸ç»´æŠ¤"
    state["research_plan"] = """
ç ”ç©¶è®¡åˆ’ï¼š
1. äº†è§£ç”µåŠ›ç³»ç»Ÿçš„åŸºæœ¬æ¦‚å¿µå’Œç»„æˆéƒ¨åˆ†
2. æ”¶é›†ç”µåŠ›ç³»ç»Ÿè¿è¡Œçš„ç›¸å…³æ ‡å‡†å’Œè§„èŒƒ
3. ç ”ç©¶ç”µåŠ›ç³»ç»Ÿç»´æŠ¤çš„æœ€ä½³å®è·µ
4. åˆ†æç”µåŠ›ç³»ç»Ÿæ•…éšœå¤„ç†çš„æ–¹æ³•
5. æ€»ç»“ç”µåŠ›ç³»ç»Ÿå®‰å…¨è¿è¡Œçš„å…³é”®è¦ç´ 
"""
    state["gathered_data"] = """
=== æœç´¢æŸ¥è¯¢ 1: ç”µåŠ›ç³»ç»Ÿè¿è¡Œ ===

çŸ¥è¯†åº“æœç´¢ç»“æœ:
æœç´¢æŸ¥è¯¢: ç”µåŠ›ç³»ç»Ÿ
æ‰¾åˆ° 3 ä¸ªç›¸å…³æ–‡æ¡£:

1. ç”µåŠ›è¡Œä¸šè¯æ±‡ ç¬¬9éƒ¨åˆ†ç”µç½‘è°ƒåº¦.pdf
   è¯„åˆ†: 26.775
   åŸå§‹å†…å®¹: ç”µåŠ›ç³»ç»Ÿè¿‡è´Ÿè· ç”µåŠ›ç³»ç»Ÿæ¢å¤çŠ¶æ€ ç”µåŠ›ç³»ç»Ÿç›‘è§†æ§åˆ¶ ç”µåŠ›ç³»ç»Ÿç´§æ€¥çŠ¶æ€ ç”µåŠ›ç³»ç»Ÿç»æµè°ƒåº¦æ§åˆ¶ ç”µåŠ›ç³»ç»Ÿè­¦æˆ’çŠ¶æ€ ç”µåŠ›ç³»ç»Ÿé¢‘ç‡å´©æºƒ ç”µåŠ›ç³»ç»Ÿé¢‘ç‡è°ƒæ•´ ç”µåŠ›ç³»ç»Ÿé¢‘ç‡å¼‚å¸¸è¿è¡Œ ç”µåŠ›ç³»ç»Ÿæ—¥è°ƒåº¦è®¡åˆ’ ç”µåŠ›ç³»ç»Ÿå®æ—¶è´Ÿè·é¢„æµ‹ ç”µåŠ›ç³»ç»ŸåŒæ­¥ç›¸é‡æµ‹é‡ ç”µåŠ›ç³»ç»Ÿç“¦è§£ ç”µåŠ›ç³»ç»Ÿç¨³å®šæ§åˆ¶...

=== æœç´¢æŸ¥è¯¢ 2: å˜ç”µç«™è®¾å¤‡ç»´æŠ¤ ===

çŸ¥è¯†åº“æœç´¢ç»“æœ:
æœç´¢æŸ¥è¯¢: å˜ç”µç«™
æ‰¾åˆ° 3 ä¸ªç›¸å…³æ–‡æ¡£:

1. åŸå¸‚ç”µåŠ›ç½‘è§„åˆ’è®¾è®¡å¯¼åˆ™.pdf
   è¯„åˆ†: 23.612
   åŸå§‹å†…å®¹: å˜ç”µç«™ç”² å˜ç”µç«™ä¹™ å˜ç”µç«™ä¸™ å›¾ B3a ç”µç¼†çº¿è·¯æ”¯æ¥ä¸‰ä¸ªå˜ç”µç«™(ä¸¤ä¾§ç”µæº, ä¸¤å°å˜) å˜ç”µç«™ç”² å˜ç”µç«™ä¹™ å˜ç”µç«™ä¸™ å›¾ B3b ç”µç¼†çº¿è·¯æ”¯æ¥ä¸‰ä¸ªå˜ç”µç«™(ä¸¤ä¾§ç”µæº, ä¸‰å°å˜) å˜ç”µç«™ç”² å˜ç”µç«™ä¹™ å›¾ B4 é«˜å‹ç”µç¼†çº¿è·¯é“¾å¼æ¥çº¿...

=== æœç´¢æŸ¥è¯¢ 3: è¾“ç”µçº¿è·¯æ•…éšœå¤„ç† ===

çŸ¥è¯†åº“æœç´¢ç»“æœ:
æœç´¢æŸ¥è¯¢: è¾“ç”µ
æ‰¾åˆ° 3 ä¸ªç›¸å…³æ–‡æ¡£:

1. ç”µåŠ›è¡Œä¸šè¯æ±‡ ç¬¬7éƒ¨åˆ† è¾“ç”µç³»ç»Ÿ.pdf
   è¯„åˆ†: 25.814
   åŸå§‹å†…å®¹: *DL/T 1033.7-2006 ç›´æµé«˜ç”µå‹å‘ç”Ÿå™¨ ç›´æµéš”ç¦»å¼€å…³ ç›´æµæ¥åœ°å¼€å…³ ç›´æµç»ç¼˜å­ ç›´æµçŸ³å¢¨åŒ– ç›´æµè¾“ç”µ ç›´æµè¾“ç”µæ½®æµåè½¬æ§åˆ¶ ç›´æµè¾“ç”µç”µç¼†çº¿è·¯ ç›´æµè¾“ç”µåŠŸç‡æ§åˆ¶ ç›´æµè¾“ç”µæ¶ç©ºçº¿è·¯ ç›´æµè¾“ç”µæ¥åœ° ç”µæ ç›´æµè¾“ç”µæ¥åœ°æçº¿è·¯ ç›´æµè¾“ç”µæ¥åœ°æå¼•çº¿ ç›´æµè¾“ç”µæ§åˆ¶...
"""

    # åˆ›å»ºLLMå®¢æˆ·ç«¯
    llm_config = settings.supported_models.get("qwen_2_5_235b_a22b")
    if not llm_config:
        raise ValueError("âŒ æ²¡æœ‰æ‰¾åˆ°qwen_2_5_235b_a22bé…ç½®ï¼Œè¯·æ£€æŸ¥é…ç½®æ–‡ä»¶")

    print(f"âœ… ä½¿ç”¨æ¨¡å‹: {llm_config.model_id}")
    print(f"âœ… APIåœ°å€: {llm_config.url}")

    llm_client = InternalLLMClient(base_url=llm_config.url,
                                   api_key=llm_config.api_key,
                                   model_name=llm_config.model_id)

    print(f"ğŸ“ æµ‹è¯•ä¸»é¢˜: {state['topic']}")
    print(f"ğŸ“Š ç ”ç©¶è®¡åˆ’é•¿åº¦: {len(state['research_plan'])} å­—ç¬¦")
    print(f"ğŸ“Š æ”¶é›†æ•°æ®é•¿åº¦: {len(state['gathered_data'])} å­—ç¬¦")
    print("=" * 60)

    # æ‰§è¡Œwriter_node
    try:
        result = writer_node(state, llm_client)

        print("\n" + "=" * 60)
        print("ğŸ“„ ç”Ÿæˆçš„æ–‡æ¡£:")
        print("=" * 60)

        final_document = result.get("final_document", "")
        print(f"æ–‡æ¡£é•¿åº¦: {len(final_document)} å­—ç¬¦")
        print("\n" + final_document)

        # åˆ†æç»“æœ
        if "ç”µåŠ›ç³»ç»Ÿ" in final_document and "å˜ç”µç«™" in final_document:
            print("\nâœ… æ–‡æ¡£ç”ŸæˆæˆåŠŸï¼Œå†…å®¹ç›¸å…³ä¸”ç»“æ„è‰¯å¥½")
        elif "æ–‡æ¡£ç”Ÿæˆé”™è¯¯" in final_document:
            print("\nâš ï¸  æ–‡æ¡£ç”Ÿæˆè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯")
        else:
            print("\nâŒ æ–‡æ¡£ç”Ÿæˆå¯èƒ½å­˜åœ¨é—®é¢˜")

        return True

    except Exception as e:
        print(f"âŒ æµ‹è¯•å¤±è´¥: {str(e)}")
        return False


def main():
    """ä¸»å‡½æ•°"""
    success = test_writer_node()

    if success:
        print("\nğŸ‰ æµ‹è¯•å®Œæˆï¼")
    else:
        print("\nâš ï¸  æµ‹è¯•å¤±è´¥ï¼")


if __name__ == "__main__":
    main()
